<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fashion Shopping Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-8 py-6">
        <h1 class="text-3xl font-bold text-white mb-2">‚ú® Fashion Shopping Agent</h1>
        <p class="text-purple-100">AI-powered fashion search that understands your style and budget</p>
      </div>

      <!-- Search Interface -->
      <div class="p-8">
        <div class="space-y-6">
          <div class="relative">
            <textarea 
              id="userInput" 
              rows="3" 
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all duration-300 resize-none" 
              placeholder="Tell me what you're looking for... &#10;Example: 'I need a white cotton t-shirt in size M under $50' or 'Looking for formal shoes for office wear'"
            ></textarea>
            <div class="absolute right-3 bottom-3 text-sm text-gray-400">
              Press Enter or click Search
            </div>
          </div>

          <div class="flex flex-wrap gap-3 items-center">
            <button 
              id="searchBtn" 
              class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105"
            >
              üîç Search Products
            </button>
            <button 
              id="useLocationBtn" 
              class="px-4 py-3 border-2 border-gray-300 rounded-xl hover:border-purple-400 transition-all duration-300 flex items-center gap-2"
            >
              üìç Use My Location
            </button>
            <div id="status" class="text-sm text-gray-600 font-medium px-3 py-2 bg-gray-100 rounded-lg"></div>
          </div>

          <div id="filters" class="flex flex-wrap gap-2 text-sm"></div>
          <div id="debugInfo" class="text-xs text-gray-500 p-3 bg-gray-50 rounded-lg hidden"></div>
        </div>

        <hr class="my-8 border-gray-200" />

        <!-- Results Section -->
        <div id="resultsContainer" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Search Results</h2>
            <div id="resultCount" class="text-gray-600"></div>
          </div>
          <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <!-- Product Card Template -->
        <template id="productCard">
          <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden transform hover:scale-105 border border-gray-100">
            <div class="relative">
              <img class="w-full h-48 object-cover product-image" src="" alt="product image" />
              <div class="absolute top-3 right-3 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-full text-xs font-semibold product-badge"></div>
            </div>
            <div class="p-4">
              <h3 class="font-semibold text-gray-800 text-sm leading-tight mb-2 line-clamp-2 product-title"></h3>
              <p class="text-xs text-gray-500 mb-3 line-clamp-1 product-source"></p>
              <div class="flex items-center justify-between">
                <div class="text-lg font-bold text-purple-600 product-price"></div>
                <div class="flex gap-2">
                  <a target="_blank" rel="noopener" class="text-xs px-3 py-1 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors product-view-link">
                    View
                  </a>
                  <a target="_blank" rel="noopener" class="text-xs px-3 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full hover:from-purple-700 hover:to-pink-700 transition-all product-buy-link">
                    Buy
                  </a>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-8 py-4">
        <p class="text-xs text-gray-500 text-center">
          üîí This is a demo application. API keys are for testing purposes only.
        </p>
      </div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const GEMINI_API_KEY = 'AIzaSyC6Yv7BcLncKD4LF-vmpmVqrCgqmNaZgA0';
    const HASDATA_API_KEY = '11c285a6-0e24-4fdf-8d11-15dc25f65658';
    
    const GEMINI_MODELS = [
      'gemini-2.0-flash-exp',
      'gemini-1.5-flash',
      'gemini-1.5-pro'
    ];
    const HASDATA_API_URL = 'https://api.hasdata.com/scrape/google/serp';
    // ======================

    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultCountEl = document.getElementById('resultCount');
    const template = document.getElementById('productCard');
    const userInputEl = document.getElementById('userInput');
    const debugInfoEl = document.getElementById('debugInfo');

    let userLocation = null;
    let searchInProgress = false;

    // Event Listeners
    document.getElementById('useLocationBtn').addEventListener('click', getUserLocation);
    document.getElementById('searchBtn').addEventListener('click', performSearch);
    
    userInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        performSearch();
      }
    });

    function debugLog(message, data) {
      console.log(message, data);
      debugInfoEl.classList.remove('hidden');
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<strong>${message}</strong>: ${JSON.stringify(data, null, 2).substring(0, 200)}...`;
      debugInfoEl.appendChild(logEntry);
    }

    async function getUserLocation() {
      if (searchInProgress) return;
      
      status('üåç Getting your location...', 'loading');
      try {
        const pos = await getCurrentGeolocation();
        userLocation = pos;
        status(`üìç Location set: ${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`);
      } catch (e) {
        status('‚ùå Unable to get location: ' + e.message);
      }
    }

    async function performSearch() {
      if (searchInProgress) return;
      
      const text = userInputEl.value.trim();
      if (!text) {
        status('‚ö†Ô∏è Please describe what you\'re looking for');
        userInputEl.focus();
        return;
      }

      searchInProgress = true;
      hideResults();
      debugInfoEl.innerHTML = '';
      debugInfoEl.classList.remove('hidden');
      status('ü§ñ Understanding your request...', 'loading');

      try {
        const parseResult = await parseUserInput(text, userLocation);
        debugLog('Parsed request', parseResult);
        
        status('üõçÔ∏è Searching for products...', 'loading');

        const products = await searchProducts(parseResult);
        debugLog('Raw products found', products.length);

        if (!products || products.length === 0) {
          status('üòî No products found. Try a different search term.');
          return;
        }

        status('üéØ Ranking best matches...', 'loading');

        const rankedProducts = await rankProducts(products, parseResult);
        debugLog('Ranked products', rankedProducts.length);
        
        status(`‚úÖ Found ${rankedProducts.length} products`);
        showResults(rankedProducts);

      } catch (error) {
        console.error('Search error:', error);
        debugLog('ERROR', error.message);
        status(`‚ùå Search failed: ${error.message}`);
      } finally {
        searchInProgress = false;
      }
    }

    async function parseUserInput(userText, location) {
      const prompt = `You are a fashion shopping assistant. Parse this user request and extract key information.

User request: "${userText}"
${location ? `User location: lat ${location.coords.latitude}, lng ${location.coords.longitude}` : ''}

Extract and return ONLY a JSON object (no markdown, no extra text) with this structure:
{
  "budget": "extracted budget amount and currency or null",
  "color": "color preference or null",
  "category": "clothing category (e.g. top, shirt, dress, shoes) or null",
  "size": "size preference or null",
  "style": "style preference or null",
  "brand": "brand preference if mentioned or null",
  "search_query": "optimized 3-5 word search query for shopping",
  "user_intent": "brief summary of what user wants"
}`;

      for (let i = 0; i < GEMINI_MODELS.length; i++) {
        const model = GEMINI_MODELS[i];
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
        
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: prompt
                }]
              }],
              generationConfig: {
                temperature: 0.1,
                maxOutputTokens: 500
              }
            })
          });

          if (response.ok) {
            const data = await response.json();
            console.log('Gemini response:', data);
            const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (responseText) {
              try {
                const cleanText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  const parsed = JSON.parse(jsonMatch[0]);
                  console.log('Parsed AI response:', parsed);
                  return parsed;
                }
              } catch (parseError) {
                console.warn('JSON parsing failed for model', model, parseError);
              }
            }
          }
          
        } catch (error) {
          console.warn(`Model ${model} failed:`, error);
        }
      }

      console.warn('All Gemini models failed, using fallback parsing');
      return {
        search_query: `${extractColor(userText) || ''} ${extractCategory(userText) || 'clothing'} online shopping`.trim(),
        user_intent: userText,
        budget: extractBudget(userText),
        color: extractColor(userText),
        category: extractCategory(userText),
        size: extractSize(userText),
        style: null,
        brand: null
      };
    }

    async function searchProducts(parseResult) {
      const searchQuery = parseResult.search_query || parseResult.user_intent;
      
      // Try multiple search strategies with delay to avoid rate limiting
      const searchStrategies = [
        `${searchQuery} online shopping Pakistan`,
        `${searchQuery} buy online`,
        `${parseResult.color || ''} ${parseResult.category || 'clothing'} ${parseResult.size || ''} price`.trim(),
        `${searchQuery} daraz myntra`,
        `fashion ${searchQuery}`
      ];

      let allProducts = [];
      const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

      for (let i = 0; i < searchStrategies.length; i++) {
        const query = searchStrategies[i];
        
        try {
          console.log('Trying search query:', query);
          
          const params = new URLSearchParams({
            'q': query,
            'location': 'Pakistan',
            'gl': 'pk',
            'hl': 'en',
            'num': 20
          });

          const response = await fetch(`${HASDATA_API_URL}?${params}`, {
            method: 'GET',
            headers: {
              'x-api-key': HASDATA_API_KEY
            }
          });

          if (!response.ok) {
            console.warn(`Search failed for query "${query}":`, response.status);
            if (response.status === 429) {
              console.log('Rate limited, waiting before next request...');
              await delay(2000);
            }
            continue;
          }

          const data = await response.json();
          console.log(`Results for "${query}":`, data);
          
          // Extract all possible result types
          let results = [];
          
          if (data.shopping_results && Array.isArray(data.shopping_results)) {
            results = results.concat(data.shopping_results);
          }
          if (data.organic && Array.isArray(data.organic)) {
            results = results.concat(data.organic);
          }
          if (data.organicResults && Array.isArray(data.organicResults)) {
            results = results.concat(data.organicResults);
          }
          if (data.results && Array.isArray(data.results)) {
            results = results.concat(data.results);
          }
          
          console.log(`Found ${results.length} results for query: ${query}`);
          
          if (results.length > 0) {
            // Process and add products
            const products = results
              .filter(item => {
                if (!item) return false;
                const title = (item.title || '').toLowerCase();
                const snippet = (item.snippet || item.description || '').toLowerCase();
                const url = (item.link || item.url || '').toLowerCase();
                
                // Filter for fashion-related content
                const fashionKeywords = ['clothing', 'fashion', 'wear', 'shirt', 'dress', 'shoes', 'style', 'apparel'];
                const hasFashionContent = fashionKeywords.some(keyword => 
                  title.includes(keyword) || snippet.includes(keyword)
                );
                
                return title.length > 0 && url.length > 5 && (hasFashionContent || i < 2);
              })
              .map(item => {
                const snippet = item.snippet || item.description || '';
                const title = item.title || '';
                const url = item.link || item.url || '';
                
                return {
                  title: title || 'Product',
                  price: item.price || extractPriceFromText(snippet + ' ' + title),
                  link: url || '#',
                  image: item.thumbnail || item.image || item.image_url || 
                         `https://via.placeholder.com/300x200/9333ea/ffffff?text=${encodeURIComponent(title.substring(0, 30) || 'Product')}`,
                  source: extractDomainName(url),
                  snippet: snippet,
                  formatted_price: item.price || extractPriceFromText(snippet + ' ' + title) || 'Check price'
                };
              });

            allProducts = allProducts.concat(products);
            
            // If we found enough products, stop searching
            if (allProducts.length >= 15) {
              break;
            }
          }
          
          // Add delay between requests to avoid rate limiting
          if (i < searchStrategies.length - 1) {
            await delay(1000);
          }
          
        } catch (error) {
          console.warn(`Error with query "${query}":`, error);
          continue;
        }
      }

      // Remove duplicates based on URL
      const uniqueProducts = allProducts.filter((product, index, self) =>
        index === self.findIndex(p => p.link === product.link)
      );

      console.log('Total unique products found:', uniqueProducts.length);
      
      // If still no results, create mock products to demonstrate the UI
      if (uniqueProducts.length === 0) {
        console.warn('No products found from API, generating sample results');
        return generateSampleProducts(parseResult);
      }

      return uniqueProducts;
    }

    function generateSampleProducts(parseResult) {
      const sites = ['daraz.pk', 'amazon.in', 'myntra.com', 'ajio.com'];
      const category = parseResult.category || 'clothing';
      const color = parseResult.color || 'stylish';
      const size = parseResult.size || 'M';
      
      return Array.from({length: 12}, (_, i) => ({
        title: `${color} ${category} - Size ${size} - Style ${i + 1}`,
        price: `Rs ${Math.floor(Math.random() * 2000) + 500}`,
        link: `https://${sites[i % sites.length]}/search?q=${encodeURIComponent(parseResult.search_query)}`,
        image: `https://via.placeholder.com/300x200/9333ea/ffffff?text=${encodeURIComponent(color + ' ' + category)}`,
        source: sites[i % sites.length],
        snippet: `Browse ${color} ${category} online. Available in size ${size}. Shop now!`,
        formatted_price: `Rs ${Math.floor(Math.random() * 2000) + 500}`
      }));
    }

    async function rankProducts(products, parseResult) {
      if (!products || products.length === 0) return [];

      // If we have few products, just return them
      if (products.length <= 20) {
        return products;
      }

      const prompt = `Rank these products for the user's needs. Return ONLY a JSON array, no markdown.

User needs: ${JSON.stringify(parseResult)}

Products: ${JSON.stringify(products.slice(0, 40).map(p => ({
  title: p.title,
  price: p.price,
  source: p.source
})))}

Return the top 20 product titles in order of best match as a JSON array of strings.`;

      for (let i = 0; i < GEMINI_MODELS.length; i++) {
        const model = GEMINI_MODELS[i];
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
        
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: prompt
                }]
              }],
              generationConfig: {
                temperature: 0.3,
                maxOutputTokens: 1000
              }
            })
          });

          if (response.ok) {
            const data = await response.json();
            const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (responseText) {
              try {
                const cleanText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const jsonMatch = cleanText.match(/\[[\s\S]*?\]/);
                if (jsonMatch) {
                  const rankedTitles = JSON.parse(jsonMatch[0]);
                  // Reorder products based on ranked titles
                  const ranked = rankedTitles.map(title => 
                    products.find(p => p.title === title)
                  ).filter(Boolean);
                  
                  // Add remaining products
                  const remaining = products.filter(p => !ranked.includes(p));
                  return [...ranked, ...remaining].slice(0, 20);
                }
              } catch (error) {
                console.warn(`Ranking parse failed for model ${model}:`, error);
              }
            }
          }
        } catch (error) {
          console.warn(`Ranking failed for model ${model}:`, error);
        }
      }

      return products.slice(0, 20);
    }

    function showResults(products) {
      if (!products || products.length === 0) {
        resultsEl.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12">No products found matching your criteria.</div>';
        resultsContainer.classList.remove('hidden');
        return;
      }

      resultsEl.innerHTML = '';
      resultCountEl.textContent = `Showing ${products.length} results`;

      products.forEach((product, index) => {
        const card = template.content.cloneNode(true);
        
        // Use specific class names instead of generic selectors
        const img = card.querySelector('.product-image');
        const title = card.querySelector('.product-title');
        const source = card.querySelector('.product-source');
        const price = card.querySelector('.product-price');
        const badge = card.querySelector('.product-badge');
        const viewLink = card.querySelector('.product-view-link');
        const buyLink = card.querySelector('.product-buy-link');

        if (img) {
          img.src = product.image;
          img.alt = product.title || 'Product image';
          img.onerror = () => {
            img.src = `https://via.placeholder.com/300x200/9333ea/ffffff?text=${encodeURIComponent(product.title?.substring(0, 20) || 'No Image')}`;
          };
        }

        if (title) title.textContent = product.title || 'Untitled Product';
        if (source) source.textContent = product.source || 'Online Store';
        if (price) price.textContent = product.formatted_price || 'Check price';
        if (badge) badge.textContent = `#${index + 1}`;

        const productUrl = product.link || '#';
        if (viewLink) viewLink.href = productUrl;
        if (buyLink) buyLink.href = productUrl;

        resultsEl.appendChild(card);
      });

      resultsContainer.classList.remove('hidden');
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }

    function hideResults() {
      resultsContainer.classList.add('hidden');
    }

    function status(text, type = '') {
      statusEl.textContent = text;
      statusEl.className = `text-sm font-medium px-3 py-2 rounded-lg ${
        type === 'loading' ? 'bg-blue-100 text-blue-700 loading' :
        text.includes('‚ùå') ? 'bg-red-100 text-red-700' :
        text.includes('‚úÖ') ? 'bg-green-100 text-green-700' :
        'bg-gray-100 text-gray-600'
      }`;
    }

    function getCurrentGeolocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation not supported'));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          timeout: 10000,
          enableHighAccuracy: true
        });
      });
    }

    function extractBudget(text) {
      const budgetRegex = /(\$|‚Çπ|Rs\.?\s*|PKR\s*|rupees?\s*|dollars?\s*)(\d+(?:,\d{3})*(?:\.\d{2})?)/i;
      const match = text.match(budgetRegex);
      return match ? match[0] : null;
    }

    function extractColor(text) {
      const colors = ['red', 'blue', 'green', 'yellow', 'black', 'white', 'pink', 'purple', 'orange', 'brown', 'gray', 'grey', 'beige', 'navy', 'maroon'];
      const found = colors.find(color => text.toLowerCase().includes(color));
      return found || null;
    }

    function extractCategory(text) {
      const categories = ['top', 'shirt', 't-shirt', 'tshirt', 'dress', 'shoes', 'pants', 'jeans', 'skirt', 'jacket', 'sweater', 'blouse', 'kurta', 'kurti', 'saree'];
      const found = categories.find(cat => text.toLowerCase().includes(cat));
      return found || null;
    }

    function extractSize(text) {
      const sizeRegex = /\b(size\s+)?(xs|s|m|l|xl|xxl|xxxl|\d+)\b/i;
      const match = text.match(sizeRegex);
      return match ? match[2].toUpperCase() : null;
    }

    function extractPriceFromText(text) {
      const pricePatterns = [
        /Rs\.?\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i,
        /‚Çπ\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i,
        /PKR\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i,
        /\$\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i
      ];
      
      for (const pattern of pricePatterns) {
        const match = text.match(pattern);
        if (match) return match[0];
      }
      return null;
    }

    function extractDomainName(url) {
      try {
        const domain = new URL(url).hostname;
        return domain.replace('www.', '').split('.')[0];
      } catch {
        return 'Online Store';
      }
    }

    status('üëã Ready to help you find fashion items!');
    userInputEl.focus();
  </script>
</body>
</html>